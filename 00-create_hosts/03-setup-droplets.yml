---
- name: Start up
  hosts: all
  gather_facts: no


  tasks:
  - name: Install cowsay
    package:
      name: cowsay
      state: installed
    when: install_cowsay

  - name: Create ssh-key
    become_user: '{{ ssh_user }}'
    become: yes
    shell: ssh-keygen -f {{ ssh_keyfile }} -P ''
           creates={{ ssh_keyfile }}

  - name: Read SSH pubkey
    shell: cat {{ ssh_keyfile }}.pub
    check_mode: false
    changed_when: false
    register: _ssh_keydata

  - name: Add the key
    with_items: [ root, ansible ]
    authorized_key:
       key: '{{ _ssh_keydata.stdout }}'
       user: '{{ item }}'
       state: present

  - name: Setup ansible inventory
    copy:
      content: "me    ansible_host={{ ansible_host }} ansible_user=root\n"
      dest: /etc/ansible/hosts

  - name: Setup ansible.cfg
    copy:
      src: ansible.cfg
      dest: /etc/ansible/ansible.cfg

  - name: Enable password auth
    lineinfile:
      dest: /etc/ssh/sshd_config
      line: "PasswordAuthentication yes"
      regexp: "^PasswordAuthentication"
    notify: "restart ssh"


  - name: Setup .vimrc
    copy:
       content: |
          autocmd BufRead *.yaml,*.yml setlocal syntax=yaml autoindent sw=8 ts=8 sts=8 expandtab colorcolumn=78,120
          colorscheme ron
       dest: /home/ansible/.vimrc
       owner: '{{ ssh_user }}'
       group: '{{ ssh_user }}'

  - name: Clone day-1
    git:
       dest: /home/ansible/day-001
       repo: https://github.com/hub-404/ansible-day-1
    become: true
    become_user: '{{ ssh_user }}'



  handlers:
    - name: "restart ssh"
      service: name=sshd state=reloaded
